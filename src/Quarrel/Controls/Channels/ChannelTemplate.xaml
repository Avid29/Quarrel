<UserControl
    x:Class="Quarrel.Controls.Channels.ChannelTemplate"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Quarrel.Controls.Channels"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:convertbase="using:Quarrel.Converters.Base"
    xmlns:convertchannel="using:Quarrel.Converters.Channel"
    xmlns:convertdiscord="using:Quarrel.Converters.Discord"
    xmlns:bindables="using:Quarrel.Models.Bindables"
    xmlns:controls="using:Quarrel.Controls"
    xmlns:interactivity="using:Microsoft.Xaml.Interactivity"
    xmlns:core="using:Microsoft.Xaml.Interactions.Core"
    xmlns:behaviors="using:Quarrel.Xaml.Behaviors"
    xmlns:tkcontrols="using:Microsoft.Toolkit.Uwp.UI.Controls"
    mc:Ignorable="d"
    d:DesignHeight="300"
    d:DesignWidth="400">

    <UserControl.Resources>
        <convertbase:NotBoolToVisibilityConverter x:Key="NotBoolToVisibilityConverter"/>
        <convertbase:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <convertbase:EnumerableAnyToVisibilityConverter x:Key="EnumerableAnyToVisibilityConverter"/>
        <convertchannel:MentionCountToVisiblityConverter x:Key="MentionCountToVisiblityConverter"/>
        <convertchannel:SelectedToOpacityConverter x:Key="SelectedToOpacityConverter"/>
        <convertchannel:TypeToBrushConverter x:Key="TypeToBrushConverter"/>
        <convertchannel:TypeToMinHeightConverter x:Key="TypeToMinHeightConverter"/>
        <convertdiscord:DiscriminatorToBrushConverter x:Key="DiscriminatorToBrush"/>
    </UserControl.Resources>

    <UserControl.ContextFlyout>
        <MenuFlyout MenuFlyoutPresenterStyle="{StaticResource DefaultMenuFlyoutPresenterStyle}">
            <!--Shared-->
            <MenuFlyoutItem Text="Mark as read" Visibility="{x:Bind ViewModel.IsTypingChannel, Mode=OneWay}" IsEnabled="{x:Bind ViewModel.IsUnread, Mode=OneWay}" Command="{x:Bind ViewModel.MarkAsRead, Mode=OneWay}"/>
            <ToggleMenuFlyoutItem Text="Mute" IsChecked="{x:Bind ViewModel.Muted, Mode=OneWay}" Visibility="{x:Bind ViewModel.IsTypingChannel, Mode=OneWay}" Command="{x:Bind ViewModel.Mute, Mode=OneWay}"/>
            <!--<MenuFlyoutItem Text="Channel Settings" Visibility="{x:Bind ViewModel.IsGuildChannel, Mode=OneWay}"/>-->
            <!--Text Channel-->
            <MenuFlyoutSubItem Text="Notifications" IsEnabled="False" Visibility="{x:Bind ViewModel.IsTextChannel, Mode=OneWay}"/>
            <!--Voice Channel-->
            <ToggleMenuFlyoutItem Text="Hide names" IsEnabled="False" Visibility="{x:Bind ViewModel.IsVoiceChannel, Mode=OneWay}"/>
            <!--Group Channel-->
            <MenuFlyoutItem Text="Leave Group" Visibility="{x:Bind ViewModel.IsGroupChannel, Mode=OneWay}" Foreground="{ThemeResource dnd}"/>
            <MenuFlyoutSeparator/>
            <MenuFlyoutItem Text="Copy Id"/>
        </MenuFlyout>
    </UserControl.ContextFlyout>

    <Grid Visibility="{x:Bind ViewModel.Hidden, Converter={StaticResource NotBoolToVisibilityConverter}, Mode=OneWay}" MinHeight="{x:Bind ViewModel.Model.Type, Converter={StaticResource TypeToMinHeightConverter}, Mode=OneWay}" Padding="22,0,24,0">
        <Grid.Background>
            <SolidColorBrush Color="{ThemeResource SystemAccentColor}" Opacity="{x:Bind ViewModel.Selected, Converter={StaticResource SelectedToOpacityConverter}, Mode=OneWay}"/>
        </Grid.Background>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition/>
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition/>
            <RowDefinition Height="Auto" MaxHeight="300"/>
            <RowDefinition Height="Auto" MaxHeight="10"/>
        </Grid.RowDefinitions>
        <Rectangle x:Name="HoverCache" Visibility="Collapsed" Fill="{ThemeResource AcrylicChannelPaneBackground}" Opacity="0.4" Grid.RowSpan="4" Grid.ColumnSpan="4" Margin="-22,-18,-24,0"/>
        <Border x:Name="SelectIndicator" Opacity="0" BorderBrush="{Binding Background, ElementName=UnreadIndicator}" BorderThickness="0,0,0,0" HorizontalAlignment="Stretch" Margin="-24,0" Grid.ColumnSpan="3" Grid.RowSpan="12">
            <Border.Background>
                <SolidColorBrush Opacity="0.2" Color="{ThemeResource SystemAccentColor}"/>
            </Border.Background>
        </Border>
        <Border x:Name="UnreadIndicator" Visibility="{x:Bind ViewModel.ShowUnread, Mode=OneWay}" Height="24" Width="2" Background="{ThemeResource Foreground}" Margin="-22,0,4,0" HorizontalAlignment="Left" Opacity="0.75"/>
        <Grid x:Name="grid" Visibility="{x:Bind ViewModel.MentionCount, Converter={StaticResource MentionCountToVisiblityConverter}, Mode=OneWay}" Grid.RowSpan="4" Grid.ColumnSpan="4" Margin="0,0,-24,0">
            <Grid.Background>
                <LinearGradientBrush EndPoint="0,0" StartPoint="1.3,0" ColorInterpolationMode="ScRgbLinearInterpolation" SpreadMethod="Pad">
                    <GradientStop Offset="0.95" Color="#00000000"/>
                    <GradientStop Color="{ThemeResource SystemAccentColor}" Offset="0"/>
                </LinearGradientBrush>
            </Grid.Background>
            <Border Visibility="Visible" Height="24" Width="2" Background="{ThemeResource SystemControlBackgroundAccentBrush}" Margin="-22,0,4,0" HorizontalAlignment="Left" Opacity="1"/>

            <TextBlock x:Name="NotificationCounter" Foreground="{ThemeResource SystemControlBackgroundAccentBrush}" Text="{x:Bind ViewModel.MentionCount, Mode=OneWay}" FontWeight="SemiBold" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="24,0,24,2" FontSize="15" RenderTransformOrigin="0.5,0.5">
                                <!--<TextBlock.RenderTransform>
                                    <CompositeTransform TranslateX="24"/>
                                </TextBlock.RenderTransform>-->
            </TextBlock>
        </Grid>
        <Rectangle Visibility="{x:Bind ViewModel.ShowIconBackdrop, Mode=OneWay}" Fill="{x:Bind ViewModel.FirstUserDiscriminator, Converter={StaticResource DiscriminatorToBrush}, Mode=OneWay}" x:Name="ChannelImageBackdrop" Width="36" Height="36"  Margin="0,6,6,6" RadiusX="18" RadiusY="18" Opacity="1"/>

        <Border Margin="0,6,6,6" Visibility="{x:Bind ViewModel.IsPrivateChannel}" CornerRadius="18">
            <tkcontrols:ImageEx Source="{x:Bind ViewModel.ImageUrl, Mode=OneWay}" Width="36" Height="36" DecodePixelWidth="36" DecodePixelHeight="36"/>
        </Border>
        <!--<Rectangle Visibility="{x:Bind ViewModel.ImageUri, Converter={StaticResource NullToVisibilityConverter}, Mode=OneWay}" Width="36" Height="36" Margin="0,6,6,6" RadiusX="18" RadiusY="18">
                            <Rectangle.Fill>
                                <ImageBrush ImageSource="ms-appx///Assets/QuarrelClassicIcon.png"/>
                            </Rectangle.Fill>
                        </Rectangle>-->

        <!--<Rectangle Visibility="Collapsed" x:Name="rectangle" Fill="#43b581" StrokeThickness="2" Stroke="{ThemeResource LightBG}" Width="14" Height="14" RadiusX="6" RadiusY="6"  VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,24,4,0" RenderTransformOrigin="0.5,0.5">
                            <Rectangle.RenderTransform>
                                <CompositeTransform TranslateX="0"/>
                            </Rectangle.RenderTransform>
                        </Rectangle>-->

        <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="0,6" Padding="0,0,-18,0">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Visibility="{x:Bind ViewModel.Permissions.ReadMessages, Converter={StaticResource NotBoolToVisibilityConverter}}" Text="" Opacity="{x:Bind ViewModel.TextOpacity, Mode=OneWay}" FontSize="14" Margin="-2,4,6,6" FontFamily="Segoe MDL2 Assets" />
                <SymbolIcon x:Name="MuteIcon" Visibility="{x:Bind ViewModel.Muted}" Symbol="Mute" Margin="0,0,4,0" Opacity="0.35"/>
                <local:CategoryChveron Visibility="{x:Bind ViewModel.IsCategory}" IsCollapsed="{x:Bind ViewModel.Collapsed, Mode=OneWay}" Grid.Column="2" HorizontalAlignment="Left" Grid.ColumnSpan="4" Margin="0,0,12,0" VerticalAlignment="Center"/>
                <TextBlock Visibility="{x:Bind ViewModel.IsVoiceChannel}" Text="" Opacity="{x:Bind ViewModel.TextOpacity, Mode=OneWay}" FontSize="14" Margin="-2,4,6,6" FontFamily="Segoe MDL2 Assets" />
                <TextBlock Visibility="{x:Bind ViewModel.IsTextChannel}" Text="#" Opacity="{x:Bind ViewModel.TextOpacity, Mode=OneWay}" Foreground="{StaticResource Foreground}" FontSize="20" FontWeight="Light" Margin="0,-2,4,0"/>
                <TextBlock Text="{x:Bind ViewModel.FormattedName, Mode=OneWay}" Opacity="{x:Bind ViewModel.TextOpacity, Mode=OneWay}" Foreground="{x:Bind ViewModel.Model.Type, Converter={StaticResource TypeToBrushConverter}, Mode=OneWay}" Margin="0,1,0,0"/>
            </StackPanel>
            <TextBlock x:Name="SubTitle" Visibility="Collapsed" Text="" FontSize="11" FontWeight="SemiBold" Opacity="0.4"/>
            <StackPanel Orientation="Horizontal">
                <TextBlock Visibility="Collapsed" x:Name="playing" Text="Playing" VerticalAlignment="Center" FontSize="11" FontWeight="SemiLight" Opacity="0.4" Foreground="{ThemeResource Foreground}" Margin="0,0,3,0"/>
                <TextBlock Visibility="Collapsed" x:Name="game" VerticalAlignment="Center" Opacity="0.8" FontSize="11" FontWeight="Normal" Foreground="{ThemeResource Foreground}" Margin="0,0,0,0"/>
                <FontIcon Visibility="Collapsed" x:Name="rich" Glyph="" FontSize="11" Margin="4,0,0,-2" Foreground="{ThemeResource Foreground}"/>
            </StackPanel>
        </StackPanel>
        <StackPanel Grid.Column="2" Orientation="Horizontal">
            <controls:TypingIndicator Visibility="{x:Bind ViewModel.IsTyping, Mode=OneWay}" HorizontalAlignment="Right" Margin="6,0"/>
        </StackPanel>

        <ListView x:Name="MemberList" ItemsSource="{x:Bind ViewModel.ConnectedUsers.Values, Mode=OneWay}" x:Load="{x:Bind ViewModel.ConnectedUsers.Values, Converter={StaticResource EnumerableAnyToVisibilityConverter}, Mode=OneWay}" SelectionMode="None" IsItemClickEnabled="True" Grid.Row="1" Grid.ColumnSpan="2" Margin="-24,0,-24,12" ItemContainerStyle="{StaticResource ChannelItemStyle}">
            <interactivity:Interaction.Behaviors>
                <core:EventTriggerBehavior EventName="ItemClick">
                    <behaviors:OpenListViewItemFlyoutAction/>
                </core:EventTriggerBehavior>
            </interactivity:Interaction.Behaviors>
            <ListView.ItemTemplate>
                <DataTemplate x:DataType="bindables:BindableVoiceUser">
                    <local:VoiceMemberControl />
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>
    </Grid>
</UserControl>
